/*
	Copyright (C) 2015 Krzysztof Grochocki

	This file is part of Ejabberd Account Tools.

	Ejabberd Account Tools is free software: you can redistribute it and/or modify
	it under the terms of the GNU General Public License as published by
	the Free Software Foundation; either version 3, or
	(at your option) any later version.

	Ejabberd Account Tools is distributed in the hope that it will be useful,
	but WITHOUT ANY WARRANTY; without even the implied warranty of
	MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
	GNU General Public License for more details.

	You should have received a copy of the GNU General Public License
	along with GNU Radio. If not, see <http://www.gnu.org/licenses/>.
*/

function validateLogin(a,s){a.removeClass("invalid"),s.removeClass("invalid"),s.empty(),a.val()?val_login=!0:(a.addClass("invalid"),s.addClass("invalid"),s.html(ejabat.empty_field),val_login=!1)}function validatePassword(a,s){a.removeClass("invalid"),s.removeClass("invalid"),s.empty(),a.val()?val_password=!0:(a.addClass("invalid"),s.addClass("invalid"),s.html(ejabat.empty_field),val_password=!1)}function validateEmail(a,s){var e=a.val();if(e){var i=new RegExp(/^((([a-z]|\d|[!#\$%&'\*\+\-\/=\?\^_`{\|}~]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])+(\.([a-z]|\d|[!#\$%&'\*\+\-\/=\?\^_`{\|}~]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])+)*)|((\x22)((((\x20|\x09)*(\x0d\x0a))?(\x20|\x09)+)?(([\x01-\x08\x0b\x0c\x0e-\x1f\x7f]|\x21|[\x23-\x5b]|[\x5d-\x7e]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(\\([\x01-\x09\x0b\x0c\x0d-\x7f]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF]))))*(((\x20|\x09)*(\x0d\x0a))?(\x20|\x09)+)?(\x22)))@((([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))\.)+(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))\.?$/i);i.test(e)?(a.removeClass("invalid"),s.removeClass("invalid"),s.empty(),val_email=!0):(a.addClass("invalid"),s.addClass("invalid"),s.html(ejabat.invalid_email),val_email=!1)}else a.addClass("invalid"),s.addClass("invalid"),s.html(ejabat.empty_field),val_email=!1}function validateRecaptcha(a,s,e){var i=a.val();i||null==i?(s.removeClass("invalid"),e.removeClass("invalid"),e.empty(),val_recaptcha=!0):(s.addClass("invalid"),e.addClass("invalid"),e.html(ejabat.recaptcha_verify),val_recaptcha=!1)}var val_login,val_password,val_email,val_recaptcha;jQuery(document).ready(function(a){a("#login input").on("change",function(){a("#login input").val(a("#login input").val().toLowerCase().replace(ejabat.login_host,'').trim()),validateLogin(a("#login input"),a("#login span"))}),a("#password input").on("keyup change",function(s){var e=s.which||s.keyCode;9!==e&&16!==e&&validatePassword(a("#password input"),a("#password span"))}),a("#email input").on("change",function(){validateEmail(a("#email input"),a("#email span"))}),a("#ejabat_change_email").submit(function(){a("#response").css("display",""),a("#response").removeClass("ejabat-validation-errors"),a("#response").removeClass("ejabat-form-blocked"),a("#response").removeClass("ejabat-form-error"),a("#response").removeClass("ejabat-form-success"),a("#response").empty(),a("#spinner").css("visibility","visible"),validateRecaptcha(a("#g-recaptcha-response"),a("#g-recaptcha-0"),a("#recaptcha")),val_login&&val_password&&val_email&&val_recaptcha?a.ajax({method:"POST",url:ejabat.ajax_url,data:a("#ejabat_change_email").serialize(),dataType:"json",success:function(s){"success"==s.status&&(a("#ejabat_change_email")[0].reset(),a("#password input").removeClass("weak good strong"),a("#password span").empty()),a("#response").css("display","inline-block"),a("#response").addClass("ejabat-form-"+s.status),a("#response").html(s.message),a("#spinner").css("visibility","hidden")}}):(val_login||a("#login input").val()||(a("#login input").addClass("invalid"),a("#login span").addClass("invalid"),a("#login span").html(ejabat.empty_field)),val_password||a("#password input").val()||(a("#password input").addClass("invalid"),a("#password span").addClass("invalid"),a("#password span").html(ejabat.empty_field)),val_email||a("#email input").val()||(a("#email input").addClass("invalid"),a("#email span").addClass("invalid"),a("#email span").html(ejabat.empty_field)),a("#response").css("display","inline-block"),a("#response").addClass("ejabat-validation-errors"),a("#response").html(ejabat.empty_fields),a("#spinner").css("visibility","hidden"))})});